<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولد إنذار الموظف المحسّن — نظام إدارة شامل</title>
  <style>
    :root{
      --bg: linear-gradient(135deg, #f4f7fb 0%, #e8f0fe 100%);
      --card: #ffffff;
      --accent: #041b29;
      --accent2: #f3b545;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    
    * {
      box-sizing: border-box;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans Arabic',sans-serif;
    }
    
    body {
      margin: 0;
      background: var(--bg);
      color: #111;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header with navigation */
    header {
      background: var(--card);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--info));
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .header-content h1 {
      margin: 0;
      font-size: 24px;
      color: var(--accent);
      font-weight: 700;
    }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      background: #f8fafc;
      padding: 4px;
      border-radius: 10px;
    }
    
    .nav-tab {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: var(--muted);
    }
    
    .nav-tab.active {
      background: var(--accent);
      color: white;
    }
    
    .nav-tab:hover:not(.active) {
      background: #e2e8f0;
    }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Enhanced cards */
    .card {
      background: var(--card);
      padding: 24px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin: 0;
    }
    
    /* Enhanced form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .form-group {
      position: relative;
    }
    
    .form-group.full {
      grid-column: 1 / -1;
    }
    
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--accent);
      font-weight: 500;
    }
    
    .required::after {
      content: '*';
      color: var(--danger);
      margin-right: 4px;
    }
    
    input[type=text], input[type=email], input[type=file], input[type=number],
    select, textarea, input[type=date], input[type=tel] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(4,27,41,0.1);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }
    
    /* Enhanced buttons */
    .btn-group {
      display: flex;
      gap: 12px;
      justify-content: flex-start;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    button {
      background: var(--accent);
      color: white;
      border: 0;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(4,27,41,0.2);
    }
    
    .btn-secondary {
      background: var(--info);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-warning {
      background: var(--warning);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--border);
    }
    
    .btn-ghost:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Status indicators */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status.success { background: #dcfce7; color: var(--success); }
    .status.warning { background: #fef3c7; color: var(--warning); }
    .status.danger { background: #fecaca; color: var(--danger); }
    .status.info { background: #dbeafe; color: var(--info); }
    
    /* Enhanced preview */
    .preview-container {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
      align-items: start;
    }
    
    .notice {
      position: relative;
      border: 2px solid rgba(4,27,41,0.1);
      padding: 30px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), #fff);
      min-height: 400px;
      overflow: hidden;
    }
    
    .notice::before {
      content: attr(data-watermark);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(-20deg);
      font-size: 80px;
      color: rgba(4,27,41,0.04);
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      font-weight: bold;
    }
    
    .notice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      gap: 20px;
    }
    
    .notice h2 {
      margin: 0;
      font-size: 22px;
      color: var(--accent);
      font-weight: 700;
    }
    
    .meta {
      font-size: 14px;
      color: #555;
      line-height: 1.4;
    }
    
    .message-content {
      margin: 24px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border-left: 4px solid var(--accent);
      min-height: 120px;
      white-space: pre-wrap;
      font-size: 15px;
      line-height: 1.6;
    }
    
    .signature-section {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
    }
    
    .signature-img {
      max-height: 60px;
      max-width: 150px;
      object-fit: contain;
    }
    
    .company-logo {
      max-height: 80px;
      max-width: 200px;
      object-fit: contain;
      margin-bottom: 16px;
    }
    
    /* Statistics dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--accent) 0%, #0f2937 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-card h3 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 700;
    }
    
    .stat-card p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    
    /* Data table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .data-table th {
      background: var(--accent);
      color: white;
      padding: 16px 12px;
      text-align: right;
      font-weight: 600;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .data-table tr:hover {
      background: #f8fafc;
    }
    
    /* Search and filters */
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 250px;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 24px;
      border-radius: 10px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .notification.success { background: var(--success); }
    .notification.error { background: var(--danger); }
    .notification.warning { background: var(--warning); }
    .notification.info { background: var(--info); }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .preview-container {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .btn-group {
        justify-content: center;
      }
    }
    
    /* Print styles */
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { 
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
      }
      .notice::before { color: rgba(4,27,41,0.02); }
    }
    
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-left { text-align: left; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>🏢 نظام إدارة إنذارات الموظفين المحسّن</h1>
        <div class="nav-tabs">
          <button class="nav-tab active" data-tab="generator">إنشاء إنذار</button>
          <button class="nav-tab" data-tab="history">السجل</button>
          <button class="nav-tab" data-tab="statistics">الإحصائيات</button>
          <button class="nav-tab" data-tab="settings">الإعدادات</button>
        </div>
      </div>
    </header>

    <!-- Generator Tab -->
    <div id="generator" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📝 إنشاء إنذار جديد</h2>
          <div class="status info">
            <span id="statusText">جاهز للإنشاء</span>
          </div>
        </div>

        <form id="warnForm" autocomplete="off">
          <div class="form-grid">
            <div class="form-group">
              <label for="company" class="required">اسم الشركة</label>
              <input id="company" type="text" placeholder="ادخل اسم الشركة" required />
            </div>

            <div class="form-group">
              <label for="warningNo">رقم الإنذار (تلقائي)</label>
              <input id="warningNo" type="text" readonly />
            </div>

            <div class="form-group">
              <label for="employee" class="required">اسم الموظف</label>
              <input id="employee" type="text" placeholder="ادخل اسم الموظف" required />
            </div>

            <div class="form-group">
              <label for="employeeId">رقم الموظف</label>
              <input id="employeeId" type="text" placeholder="رقم الموظف (اختياري)" />
            </div>

            <div class="form-group">
              <label for="email" class="required">ايميل الموظف</label>
              <input id="email" type="email" placeholder="employee@example.com" required />
            </div>

            <div class="form-group">
              <label for="phone">رقم الهاتف</label>
              <input id="phone" type="tel" placeholder="+966 50 123 4567" />
            </div>

            <div class="form-group">
              <label for="department">القسم</label>
              <select id="department">
                <option value="">اختر القسم</option>
                <option value="الإدارة">الإدارة</option>
                <option value="الموارد البشرية">الموارد البشرية</option>
                <option value="المالية">المالية</option>
                <option value="التسويق">التسويق</option>
                <option value="المبيعات">المبيعات</option>
                <option value="تقنية المعلومات">تقنية المعلومات</option>
                <option value="خدمة العملاء">خدمة العملاء</option>
                <option value="الإنتاج">الإنتاج</option>
              </select>
            </div>

            <div class="form-group">
              <label for="type" class="required">نوع الإنذار</label>
              <select id="type" required>
                <option value="تنبيه شفهي">تنبيه شفهي</option>
                <option value="تحذير مكتوب">تحذير مكتوب</option>
                <option value="إنذار رسمي">إنذار رسمي</option>
                <option value="إنذار نهائي">إنذار نهائي</option>
                <option value="تنبيه سلوك">تنبيه سلوك</option>
                <option value="تنبيه أداء">تنبيه أداء</option>
                <option value="تنبيه حضور">تنبيه حضور</option>
              </select>
            </div>

            <div class="form-group">
              <label for="severity">درجة الخطورة</label>
              <select id="severity">
                <option value="منخفض">منخفض</option>
                <option value="متوسط">متوسط</option>
                <option value="عالي">عالي</option>
                <option value="عاجل">عاجل</option>
              </select>
            </div>

            <div class="form-group">
              <label for="date" class="required">التاريخ</label>
              <input id="date" type="date" required />
            </div>

            <div class="form-group">
              <label for="dueDate">تاريخ الاستجابة المطلوبة</label>
              <input id="dueDate" type="date" />
            </div>

            <div class="form-group">
              <label for="issuer">المُصدر</label>
              <input id="issuer" type="text" placeholder="اسم مُصدر الإنذار" />
            </div>

            <div class="form-group full">
              <label for="logo">شعار الشركة</label>
              <input id="logo" type="file" accept="image/*" />
            </div>

            <div class="form-group full">
              <label for="signature">توقيع المُصدر</label>
              <input id="signature" type="file" accept="image/*" />
            </div>

            <div class="form-group full">
              <label>
                <input id="requireSign" type="checkbox" checked />
                إظهار خانة التوقيع في المعاينة
              </label>
            </div>

            <div class="form-group full">
              <label for="message" class="required">محتوى الإنذار</label>
              <textarea id="message" placeholder="اكتب تفاصيل الإنذار هنا..." required></textarea>
            </div>

            <div class="form-group full">
              <label for="consequences">العواقب المترتبة</label>
              <textarea id="consequences" placeholder="اكتب العواقب المترتبة على عدم الالتزام..."></textarea>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" id="generateBtn" class="btn-success">✨ تحديث المعاينة</button>
            <button type="button" id="saveWarningBtn" class="btn-secondary">💾 حفظ الإنذار</button>
            <button type="button" id="printBtn" class="btn-ghost">🖨️ طباعة / PDF</button>
            <button type="button" id="copyBtn" class="btn-ghost">📋 نسخ النص</button>
            <button type="button" id="exportBtn" class="btn-ghost">📤 تصدير HTML</button>
            <button type="button" id="sendMailBtn" class="btn-ghost">📧 إرسال بريد</button>
            <button type="button" id="clearBtn" class="btn-danger">🗑️ مسح الحقول</button>
          </div>
        </form>
      </div>

      <div class="preview-container">
        <div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">👁️ معاينة الإنذار</h3>
            </div>
            <div id="preview" class="notice print-area" data-watermark="[اسم الشركة]">
              <img id="p-logo" class="company-logo" style="display:none" alt="شعار الشركة" />
              <div class="notice-header">
                <div>
                  <h2 id="p-company">[اسم الشركة]</h2>
                  <div class="meta">
                    <strong id="p-type">[نوع الإنذار]</strong> — <span id="p-date">[التاريخ]</span><br/>
                    <span>رقم الإنذار: <strong id="p-warning-no">#—</strong></span><br/>
                    <span id="p-severity-display" style="display:none">الخطورة: <span id="p-severity"></span></span>
                  </div>
                </div>
                <div class="meta text-left">
                  إلى: <strong id="p-employee">[اسم الموظف]</strong><br/>
                  <span id="p-employee-id-display" style="display:none">رقم الموظف: <span id="p-employee-id"></span></span><br/>
                  البريد: <span id="p-email">[البريد الإلكتروني]</span><br/>
                  <span id="p-department-display" style="display:none">القسم: <span id="p-department"></span></span><br/>
                  <span id="p-phone-display" style="display:none">الهاتف: <span id="p-phone"></span></span>
                </div>
              </div>

              <div class="message-content" id="p-message">[محتوى الإنذار سيظهر هنا]</div>

              <div id="p-consequences-section" style="display:none">
                <strong>العواقب المترتبة:</strong>
                <div class="message-content" id="p-consequences"></div>
              </div>

              <div id="p-due-date-display" style="display:none; margin: 16px 0;">
                <strong>تاريخ الاستجابة المطلوبة: <span id="p-due-date"></span></strong>
              </div>

              <div class="signature-section">
                <div>
                  <div id="p-sig-line">التوقيع: ____________________</div>
                  <div id="p-sig-img-wrap" style="display:none">
                    <img id="p-sig-img" class="signature-img" alt="توقيع" />
                  </div>
                  <div style="margin-top: 8px;">
                    <span id="p-issuer-display" style="display:none">المُصدر: <span id="p-issuer"></span></span>
                  </div>
                </div>
                <div class="text-left">
                  <small>تم الإنشاء: <span id="p-created"></span></small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ℹ️ إرشادات سريعة</h3>
            </div>
            <ul style="margin:0;padding-inline-start:20px;line-height:1.8">
              <li>املأ الحقول المطلوبة (المميزة بـ *)</li>
              <li>استخدم التقويم لاختيار التاريخ</li>
              <li>يمكنك حفظ الإنذار في السجل المحلي</li>
              <li>استخدم الطباعة لحفظ PDF</li>
              <li>رقم الإنذار يزيد تلقائياً</li>
              <li>جميع البيانات محفوظة محلياً في المتصفح</li>
            </ul>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">🎯 إجراءات سريعة</h3>
            </div>
            <div class="btn-group" style="flex-direction: column; gap: 8px;">
              <button type="button" id="saveTemplateBtn" class="btn-ghost">💾 حفظ كقالب</button>
              <button type="button" id="loadTemplateBtn" class="btn-ghost">📁 تحميل قالب</button>
              <button type="button" id="autoFillBtn" class="btn-ghost">🔄 بيانات تجريبية</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📚 سجل الإنذارات</h2>
          <button id="clearHistoryBtn" class="btn-danger">🗑️ مسح السجل</button>
        </div>

        <div class="search-bar">
          <input type="text" id="searchInput" class="search-input" placeholder="البحث في السجل..." />
          <select id="filterType">
            <option value="">جميع الأنواع</option>
            <option value="تنبيه شفهي">تنبيه شفهي</option>
            <option value="تحذير مكتوب">تحذير مكتوب</option>
            <option value="إنذار رسمي">إنذار رسمي</option>
            <option value="إنذار نهائي">إنذار نهائي</option>
          </select>
        </div>

        <div id="historyTableContainer">
          <p class="text-center" style="color: var(--muted); padding: 40px;">
            لا توجد إنذارات محفوظة حتى الآن. قم بإنشاء وحفظ الإنذار الأول!
          </p>
        </div>
      </div>
    </div>

    <!-- Statistics Tab -->
    <div id="statistics" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalWarnings">0</h3>
          <p>إجمالي الإنذارات</p>
        </div>
        <div class="stat-card">
          <h3 id="thisMonth">0</h3>
          <p>هذا الشهر</p>
        </div>
        <div class="stat-card">
          <h3 id="finalWarnings">0</h3>
          <p>إنذارات نهائية</p>
        </div>
        <div class="stat-card">
          <h3 id="uniqueEmployees">0</h3>
          <p>موظفين</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📊 تحليل الإنذارات</h2>
        </div>
        <div id="statisticsContent">
          <p class="text-center" style="color: var(--muted); padding: 40px;">
            سيتم عرض الإحصائيات عند وجود بيانات محفوظة
          </p>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">⚙️ إعدادات النظام</h2>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="defaultCompany">اسم الشركة الافتراضي</label>
            <input id="defaultCompany" type="text" placeholder="ادخل اسم الشركة" />
          </div>

          <div class="form-group">
            <label for="defaultIssuer">المُصدر الافتراضي</label>
            <input id="defaultIssuer" type="text" placeholder="اسم مُصدر الإنذارات" />
          </div>

          <div class="form-group">
            <label for="warningNumberStart">بداية ترقيم الإنذارات</label>
            <input id="warningNumberStart" type="number" min="1" value="1" />
          </div>

          <div class="form-group">
            <label for="autoSave">الحفظ التلقائي</label>
            <select id="autoSave">
              <option value="enabled">مفعل</option>
              <option value="disabled">معطل</option>
            </select>
          </div>
        </div>

        <div class="btn-group">
          <button type="button" id="saveSettingsBtn" class="btn-success">💾 حفظ الإعدادات</button>
          <button type="button" id="resetSettingsBtn" class="btn-danger">🔄 إعادة تعيين</button>
          <button type="button" id="exportDataBtn" class="btn-ghost">📤 تصدير البيانات</button>
          <button type="button" id="importDataBtn" class="btn-ghost">📥 استيراد البيانات</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" />
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification" class="notification"></div>

  <script>
    // DOM Elements
    const elements = {
      // Form inputs
      company: document.getElementById('company'),
      warningNo: document.getElementById('warningNo'),
      employee: document.getElementById('employee'),
      employeeId: document.getElementById('employeeId'),
      email: document.getElementById('email'),
      phone: document.getElementById('phone'),
      department: document.getElementById('department'),
      type: document.getElementById('type'),
      severity: document.getElementById('severity'),
      date: document.getElementById('date'),
      dueDate: document.getElementById('dueDate'),
      issuer: document.getElementById('issuer'),
      logo: document.getElementById('logo'),
      signature: document.getElementById('signature'),
      requireSign: document.getElementById('requireSign'),
      message: document.getElementById('message'),
      consequences: document.getElementById('consequences'),

      // Preview elements
      preview: document.getElementById('preview'),
      pCompany: document.getElementById('p-company'),
      pEmployee: document.getElementById('p-employee'),
      pEmployeeId: document.getElementById('p-employee-id'),
      pEmployeeIdDisplay: document.getElementById('p-employee-id-display'),
      pEmail: document.getElementById('p-email'),
      pPhone: document.getElementById('p-phone'),
      pPhoneDisplay: document.getElementById('p-phone-display'),
      pDepartment: document.getElementById('p-department'),
      pDepartmentDisplay: document.getElementById('p-department-display'),
      pType: document.getElementById('p-type'),
      pSeverity: document.getElementById('p-severity'),
      pSeverityDisplay: document.getElementById('p-severity-display'),
      pDate: document.getElementById('p-date'),
      pDueDate: document.getElementById('p-due-date'),
      pDueDateDisplay: document.getElementById('p-due-date-display'),
      pIssuer: document.getElementById('p-issuer'),
      pIssuerDisplay: document.getElementById('p-issuer-display'),
      pWarningNo: document.getElementById('p-warning-no'),
      pMessage: document.getElementById('p-message'),
      pConsequences: document.getElementById('p-consequences'),
      pConsequencesSection: document.getElementById('p-consequences-section'),
      pCreated: document.getElementById('p-created'),
      pLogo: document.getElementById('p-logo'),
      pSigImg: document.getElementById('p-sig-img'),
      pSigWrap: document.getElementById('p-sig-img-wrap'),
      pSigLine: document.getElementById('p-sig-line'),

      // Buttons
      generateBtn: document.getElementById('generateBtn'),
      saveWarningBtn: document.getElementById('saveWarningBtn'),
      printBtn: document.getElementById('printBtn'),
      copyBtn: document.getElementById('copyBtn'),
      exportBtn: document.getElementById('exportBtn'),
      sendMailBtn: document.getElementById('sendMailBtn'),
      clearBtn: document.getElementById('clearBtn'),
      saveTemplateBtn: document.getElementById('saveTemplateBtn'),
      loadTemplateBtn: document.getElementById('loadTemplateBtn'),
      autoFillBtn: document.getElementById('autoFillBtn'),

      // Navigation
      navTabs: document.querySelectorAll('.nav-tab'),
      tabContents: document.querySelectorAll('.tab-content'),

      // Statistics
      totalWarnings: document.getElementById('totalWarnings'),
      thisMonth: document.getElementById('thisMonth'),
      finalWarnings: document.getElementById('finalWarnings'),
      uniqueEmployees: document.getElementById('uniqueEmployees'),

      // Settings
      defaultCompany: document.getElementById('defaultCompany'),
      defaultIssuer: document.getElementById('defaultIssuer'),
      warningNumberStart: document.getElementById('warningNumberStart'),
      autoSave: document.getElementById('autoSave'),
      saveSettingsBtn: document.getElementById('saveSettingsBtn'),
      resetSettingsBtn: document.getElementById('resetSettingsBtn'),
      exportDataBtn: document.getElementById('exportDataBtn'),
      importDataBtn: document.getElementById('importDataBtn'),
      importFile: document.getElementById('importFile'),

      // History
      searchInput: document.getElementById('searchInput'),
      filterType: document.getElementById('filterType'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      historyTableContainer: document.getElementById('historyTableContainer'),

      // Notification
      notification: document.getElementById('notification')
    };

    // Storage Keys
    const STORAGE = {
      WARNING_NUMBER: 'warning_next_no_v2',
      WARNINGS_HISTORY: 'warnings_history_v2',
      TEMPLATES: 'warning_templates_v2',
      SETTINGS: 'app_settings_v2',
      DRAFT: 'warning_draft_v2'
    };

    // Initialize app
    class WarningApp {
      constructor() {
        this.warnings = this.loadWarnings();
        this.settings = this.loadSettings();
        this.init();
      }

      init() {
        this.initializeWarningNumber();
        this.setupEventListeners();
        this.loadDraft();
        this.updatePreview();
        this.updateStatistics();
        this.loadSettings();
        this.setTodayDate();
        this.startAutosave();
      }

      // Storage methods
      loadWarnings() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE.WARNINGS_HISTORY) || '[]');
        } catch {
          return [];
        }
      }

      saveWarnings() {
        localStorage.setItem(STORAGE.WARNINGS_HISTORY, JSON.stringify(this.warnings));
        this.updateStatistics();
      }

      loadSettings() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE.SETTINGS) || '{}');
        } catch {
          return {};
        }
      }

      saveSettings() {
        localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(this.settings));
      }

      // Warning number management
      initializeWarningNumber() {
        const startNumber = this.settings.warningNumberStart || 1;
        const currentNumber = parseInt(localStorage.getItem(STORAGE.WARNING_NUMBER) || startNumber);
        elements.warningNo.value = String(currentNumber).padStart(3, '0');
      }

      getNextWarningNumber() {
        const startNumber = this.settings.warningNumberStart || 1;
        const current = parseInt(localStorage.getItem(STORAGE.WARNING_NUMBER) || startNumber);
        localStorage.setItem(STORAGE.WARNING_NUMBER, String(current + 1));
        return String(current).padStart(3, '0');
      }

      // Date utilities
      formatDateArabic(dateString) {
        if (!dateString) return '[التاريخ]';
        try {
          const date = new Date(dateString + 'T00:00:00');
          return new Intl.DateTimeFormat('ar-SA', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
          }).format(date);
        } catch {
          return dateString;
        }
      }

      setTodayDate() {
        if (!elements.date.value) {
          elements.date.value = new Date().toISOString().split('T')[0];
        }
      }

      // Event listeners
      setupEventListeners() {
        // Navigation tabs
        elements.navTabs.forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });

        // Form buttons
        elements.generateBtn.addEventListener('click', () => this.generatePreview());
        elements.saveWarningBtn.addEventListener('click', () => this.saveWarning());
        elements.printBtn.addEventListener('click', () => this.printWarning());
        elements.copyBtn.addEventListener('click', () => this.copyWarning());
        elements.exportBtn.addEventListener('click', () => this.exportWarning());
        elements.sendMailBtn.addEventListener('click', () => this.sendMail());
        elements.clearBtn.addEventListener('click', () => this.clearForm());

        // Template buttons
        elements.saveTemplateBtn.addEventListener('click', () => this.saveTemplate());
        elements.loadTemplateBtn.addEventListener('click', () => this.loadTemplate());
        elements.autoFillBtn.addEventListener('click', () => this.autoFillDemo());

        // Settings buttons
        elements.saveSettingsBtn.addEventListener('click', () => this.saveAppSettings());
        elements.resetSettingsBtn.addEventListener('click', () => this.resetSettings());
        elements.exportDataBtn.addEventListener('click', () => this.exportData());
        elements.importDataBtn.addEventListener('click', () => elements.importFile.click());
        elements.importFile.addEventListener('change', (e) => this.importData(e));

        // History
        elements.clearHistoryBtn.addEventListener('click', () => this.clearHistory());
        elements.searchInput.addEventListener('input', () => this.filterHistory());
        elements.filterType.addEventListener('change', () => this.filterHistory());

        // Live preview updates
        const liveUpdateFields = [
          elements.company, elements.employee, elements.email, elements.type,
          elements.date, elements.severity, elements.department, elements.phone,
          elements.employeeId, elements.issuer, elements.dueDate
        ];
        
        liveUpdateFields.forEach(field => {
          field.addEventListener('input', () => this.updatePreview());
        });

        // File uploads
        elements.logo.addEventListener('change', () => this.handleLogoUpload());
        elements.signature.addEventListener('change', () => this.handleSignatureUpload());
        elements.requireSign.addEventListener('change', () => this.updatePreview());

        // Form submission prevention
        elements.warnForm?.addEventListener('submit', e => e.preventDefault());
      }

      // Tab switching
      switchTab(tabName) {
        elements.navTabs.forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        
        elements.tabContents.forEach(content => {
          content.classList.toggle('active', content.id === tabName);
        });

        if (tabName === 'statistics') {
          this.updateStatistics();
        } else if (tabName === 'history') {
          this.renderHistory();
        }
      }

      // Preview generation
      generatePreview() {
        if (!this.validateForm()) return;
        
        const warningNumber = this.getNextWarningNumber();
        elements.warningNo.value = warningNumber;
        this.updatePreview();
        this.showNotification('تم تحديث المعاينة بنجاح!', 'success');
        
        // Scroll to preview
        elements.preview.scrollIntoView({ behavior: 'smooth' });
      }

      updatePreview() {
        // Company and watermark
        const companyName = elements.company.value.trim() || '[اسم الشركة]';
        elements.pCompany.textContent = companyName;
        elements.preview.setAttribute('data-watermark', companyName);

        // Employee info
        elements.pEmployee.textContent = elements.employee.value.trim() || '[اسم الموظف]';
        elements.pEmail.textContent = elements.email.value.trim() || '[البريد الإلكتروني]';
        
        // Optional employee details
        this.toggleDisplay(elements.pEmployeeIdDisplay, elements.employeeId.value.trim());
        elements.pEmployeeId.textContent = elements.employeeId.value.trim();
        
        this.toggleDisplay(elements.pPhoneDisplay, elements.phone.value.trim());
        elements.pPhone.textContent = elements.phone.value.trim();
        
        this.toggleDisplay(elements.pDepartmentDisplay, elements.department.value.trim());
        elements.pDepartment.textContent = elements.department.value.trim();

        // Warning details
        elements.pType.textContent = elements.type.value;
        elements.pDate.textContent = this.formatDateArabic(elements.date.value);
        elements.pWarningNo.textContent = '#' + elements.warningNo.value;
        
        // Severity
        this.toggleDisplay(elements.pSeverityDisplay, elements.severity.value.trim());
        elements.pSeverity.textContent = elements.severity.value.trim();

        // Issuer
        this.toggleDisplay(elements.pIssuerDisplay, elements.issuer.value.trim());
        elements.pIssuer.textContent = elements.issuer.value.trim();

        // Due date
        this.toggleDisplay(elements.pDueDateDisplay, elements.dueDate.value.trim());
        elements.pDueDate.textContent = this.formatDateArabic(elements.dueDate.value);

        // Messages
        elements.pMessage.textContent = elements.message.value.trim() || '[محتوى الإنذار سيظهر هنا]';
        
        this.toggleDisplay(elements.pConsequencesSection, elements.consequences.value.trim());
        elements.pConsequences.textContent = elements.consequences.value.trim();

        // Creation date
        elements.pCreated.textContent = this.formatDateArabic(new Date().toISOString().split('T')[0]);

        // Signature handling
        if (elements.requireSign.checked) {
          elements.pSigLine.style.display = 'block';
        } else {
          elements.pSigLine.style.display = 'none';
          elements.pSigWrap.style.display = 'none';
        }
      }

      toggleDisplay(element, condition) {
        element.style.display = condition ? 'inline' : 'none';
      }

      // Form validation
      validateForm() {
        const required = [
          { field: elements.company, message: 'يرجى إدخال اسم الشركة' },
          { field: elements.employee, message: 'يرجى إدخال اسم الموظف' },
          { field: elements.email, message: 'يرجى إدخال بريد الموظف' },
          { field: elements.message, message: 'يرجى كتابة محتوى الإنذار' },
          { field: elements.date, message: 'يرجى اختيار التاريخ' }
        ];

        for (const { field, message } of required) {
          if (!field.value.trim()) {
            this.showNotification(message, 'error');
            field.focus();
            return false;
          }
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(elements.email.value)) {
          this.showNotification('يرجى إدخال بريد إلكتروني صحيح', 'error');
          elements.email.focus();
          return false;
        }

        return true;
      }

      // File handling
      handleLogoUpload() {
        const file = elements.logo.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            elements.pLogo.src = e.target.result;
            elements.pLogo.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          elements.pLogo.style.display = 'none';
        }
      }

      handleSignatureUpload() {
        const file = elements.signature.files[0];
        if (file && elements.requireSign.checked) {
          const reader = new FileReader();
          reader.onload = (e) => {
            elements.pSigImg.src = e.target.result;
            elements.pSigWrap.style.display = 'block';
            elements.pSigLine.style.display = 'none';
          };
          reader.readAsDataURL(file);
        } else {
          elements.pSigWrap.style.display = 'none';
          if (elements.requireSign.checked) {
            elements.pSigLine.style.display = 'block';
          }
        }
      }

      // Warning management
      saveWarning() {
        if (!this.validateForm()) return;

        const warning = {
          id: Date.now(),
          warningNo: elements.warningNo.value,
          company: elements.company.value.trim(),
          employee: elements.employee.value.trim(),
          employeeId: elements.employeeId.value.trim(),
          email: elements.email.value.trim(),
          phone: elements.phone.value.trim(),
          department: elements.department.value.trim(),
          type: elements.type.value,
          severity: elements.severity.value,
          date: elements.date.value,
          dueDate: elements.dueDate.value,
          issuer: elements.issuer.value.trim(),
          message: elements.message.value.trim(),
          consequences: elements.consequences.value.trim(),
          createdAt: new Date().toISOString(),
          status: 'نشط'
        };

        this.warnings.unshift(warning);
        this.saveWarnings();
        this.showNotification(`تم حفظ الإنذار رقم ${warning.warningNo} بنجاح!`, 'success');
      }

      // Action methods
      printWarning() {
        if (!this.validateForm()) return;
        this.updatePreview();
        window.print();
      }

      async copyWarning() {
        if (!this.validateForm()) return;
        
        const text = `إنذار رقم ${elements.warningNo.value}
الشركة: ${elements.pCompany.textContent}
إلى: ${elements.pEmployee.textContent} (${elements.pEmail.textContent})
النوع: ${elements.pType.textContent}
التاريخ: ${elements.pDate.textContent}

${elements.pMessage.textContent}

${elements.consequences.value ? 'العواقب المترتبة:\n' + elements.pConsequences.textContent : ''}`;

        try {
          await navigator.clipboard.writeText(text);
          this.showNotification('تم نسخ النص بنجاح!', 'success');
        } catch {
          this.showNotification('فشل في نسخ النص', 'error');
        }
      }

      exportWarning() {
        if (!this.validateForm()) return;
        this.updatePreview();
        
        const html = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>إنذار الموظف #${elements.warningNo.value}</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:40px;direction:rtl}
    .notice{border:2px solid #041b29;padding:30px;border-radius:10px;background:#fff}
    .notice-header{display:flex;justify-content:space-between;margin-bottom:20px}
    .message-content{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0;border-left:4px solid #041b29}
    .signature-section{margin-top:30px;border-top:1px solid #ccc;padding-top:20px}
  </style>
</head>
<body>${elements.preview.outerHTML}</body>
</html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `warning-${elements.warningNo.value}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification('تم تصدير الإنذار بنجاح!', 'success');
      }

      sendMail() {
        if (!this.validateForm()) return;
        
        const subject = encodeURIComponent(`إنذار موظف — ${elements.pEmployee.textContent} — ${elements.pCompany.textContent}`);
        const body = encodeURIComponent(`إنذار رقم ${elements.warningNo.value}
الشركة: ${elements.pCompany.textContent}
إلى: ${elements.pEmployee.textContent}
النوع: ${elements.pType.textContent}
التاريخ: ${elements.pDate.textContent}

${elements.pMessage.textContent}

--- تم الإنشاء عبر نظام إدارة إنذارات الموظفين`);
        
        window.location.href = `mailto:${elements.email.value}?subject=${subject}&body=${body}`;
      }

      clearForm() {
        if (!confirm('هل تريد مسح جميع الحقول؟')) return;
        
        document.getElementById('warnForm').reset();
        this.initializeWarningNumber();
        this.setTodayDate();
        elements.pLogo.style.display = 'none';
        elements.pSigWrap.style.display = 'none';
        this.updatePreview();
        this.showNotification('تم مسح الحقول بنجاح', 'info');
      }

      // Template management
      saveTemplate() {
        const template = {
          company: elements.company.value,
          issuer: elements.issuer.value,
          type: elements.type.value,
          severity: elements.severity.value,
          department: elements.department.value,
          message: elements.message.value,
          consequences: elements.consequences.value
        };
        
        localStorage.setItem(STORAGE.TEMPLATES, JSON.stringify(template));
        this.showNotification('تم حفظ القالب بنجاح!', 'success');
      }

      loadTemplate() {
        try {
          const template = JSON.parse(localStorage.getItem(STORAGE.TEMPLATES) || '{}');
          if (Object.keys(template).length === 0) {
            this.showNotification('لا يوجد قالب محفوظ', 'warning');
            return;
          }

          Object.entries(template).forEach(([key, value]) => {
            const element = elements[key];
            if (element && value) element.value = value;
          });

          this.updatePreview();
          this.showNotification('تم تحميل القالب بنجاح!', 'success');
        } catch {
          this.showNotification('خطأ في تحميل القالب', 'error');
        }
      }

      autoFillDemo() {
        const demoData = {
          company: 'شركة التقنية المتقدمة',
          employee: 'أحمد محمد السعيد',
          employeeId: 'EMP001',
          email: 'ahmed.saeed@company.com',
          phone: '+966 50 123 4567',
          department: 'تقنية المعلومات',
          type: 'تحذير مكتوب',
          severity: 'متوسط',
          issuer: 'مدير الموارد البشرية',
          message: 'نود إحاطتكم علماً بأنه تم رصد تأخير متكرر في الحضور خلال الأسبوع الماضي. نرجو منكم الالتزام بمواعيد العمل المحددة.',
          consequences: 'في حالة تكرار هذا السلوك، سيتم اتخاذ إجراءات تأديبية أكثر صرامة قد تصل إلى الإنذار النهائي.'
        };

        Object.entries(demoData).forEach(([key, value]) => {
          const element = elements[key];
          if (element) element.value = value;
        });

        this.setTodayDate();
        this.updatePreview();
        this.showNotification('تم تعبئة البيانات التجريبية!', 'info');
      }

      // Settings management
      saveAppSettings() {
        this.settings = {
          defaultCompany: elements.defaultCompany.value,
          defaultIssuer: elements.defaultIssuer.value,
          warningNumberStart: parseInt(elements.warningNumberStart.value) || 1,
          autoSave: elements.autoSave.value
        };
        
        this.saveSettings();
        this.applySettings();
        this.showNotification('تم حفظ الإعدادات بنجاح!', 'success');
      }

      loadAppSettings() {
        elements.defaultCompany.value = this.settings.defaultCompany || '';
        elements.defaultIssuer.value = this.settings.defaultIssuer || '';
        elements.warningNumberStart.value = this.settings.warningNumberStart || 1;
        elements.autoSave.value = this.settings.autoSave || 'enabled';
      }

      applySettings() {
        if (this.settings.defaultCompany && !elements.company.value) {
          elements.company.value = this.settings.defaultCompany;
        }
        if (this.settings.defaultIssuer && !elements.issuer.value) {
          elements.issuer.value = this.settings.defaultIssuer;
        }
        this.updatePreview();
      }

      resetSettings() {
        if (!confirm('هل تريد إعادة تعيين جميع الإعدادات؟')) return;
        
        this.settings = {};
        this.saveSettings();
        this.loadAppSettings();
        this.showNotification('تم إعادة تعيين الإعدادات!', 'info');
      }

      // Data management
      exportData() {
        const data = {
          warnings: this.warnings,
          settings: this.settings,
          templates: JSON.parse(localStorage.getItem(STORAGE.TEMPLATES) || '{}'),
          exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `warnings-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification('تم تصدير البيانات بنجاح!', 'success');
      }

      importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            if (data.warnings) {
              this.warnings = data.warnings;
              this.saveWarnings();
            }
            
            if (data.settings) {
              this.settings = data.settings;
              this.saveSettings();
              this.loadAppSettings();
            }
            
            if (data.templates) {
              localStorage.setItem(STORAGE.TEMPLATES, JSON.stringify(data.templates));
            }
            
            this.updateStatistics();
            this.showNotification('تم استيراد البيانات بنجاح!', 'success');
          } catch {
            this.showNotification('خطأ في قراءة ملف البيانات', 'error');
          }
        };
        reader.readAsText(file);
        
        // Reset file input
        event.target.value = '';
      }

      // History management
      renderHistory() {
        if (this.warnings.length === 0) {
          elements.historyTableContainer.innerHTML = `
            <p class="text-center" style="color: var(--muted); padding: 40px;">
              لا توجد إنذارات محفوظة حتى الآن. قم بإنشاء وحفظ الإنذار الأول!
            </p>`;
          return;
        }

        const table = `
          <table class="data-table">
            <thead>
              <tr>
                <th>رقم الإنذار</th>
                <th>الموظف</th>
                <th>النوع</th>
                <th>التاريخ</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${this.warnings.map(w => `
                <tr>
                  <td>#${w.warningNo}</td>
                  <td>${w.employee}</td>
                  <td>${w.type}</td>
                  <td>${this.formatDateArabic(w.date)}</td>
                  <td><span class="status ${this.getStatusClass(w.type)}">${w.status}</span></td>
                  <td>
                    <button onclick="app.viewWarning('${w.id}')" class="btn-ghost" style="padding:4px 8px;font-size:12px">👁️ عرض</button>
                    <button onclick="app.deleteWarning('${w.id}')" class="btn-danger" style="padding:4px 8px;font-size:12px">🗑️ حذف</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>`;
        
        elements.historyTableContainer.innerHTML = table;
      }

      filterHistory() {
        const searchTerm = elements.searchInput.value.toLowerCase();
        const typeFilter = elements.filterType.value;
        
        let filteredWarnings = this.warnings;
        
        if (searchTerm) {
          filteredWarnings = filteredWarnings.filter(w => 
            w.employee.toLowerCase().includes(searchTerm) ||
            w.warningNo.includes(searchTerm) ||
            w.company.toLowerCase().includes(searchTerm)
          );
        }
        
        if (typeFilter) {
          filteredWarnings = filteredWarnings.filter(w => w.type === typeFilter);
        }
        
        this.renderFilteredHistory(filteredWarnings);
      }

      renderFilteredHistory(warnings) {
        if (warnings.length === 0) {
          elements.historyTableContainer.innerHTML = `
            <p class="text-center" style="color: var(--muted); padding: 40px;">
              لا توجد نتائج مطابقة لبحثك
            </p>`;
          return;
        }

        const table = `
          <table class="data-table">
            <thead>
              <tr>
                <th>رقم الإنذار</th>
                <th>الموظف</th>
                <th>النوع</th>
                <th>التاريخ</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${warnings.map(w => `
                <tr>
                  <td>#${w.warningNo}</td>
                  <td>${w.employee}</td>
                  <td>${w.type}</td>
                  <td>${this.formatDateArabic(w.date)}</td>
                  <td><span class="status ${this.getStatusClass(w.type)}">${w.status}</span></td>
                  <td>
                    <button onclick="app.viewWarning('${w.id}')" class="btn-ghost" style="padding:4px 8px;font-size:12px">👁️ عرض</button>
                    <button onclick="app.deleteWarning('${w.id}')" class="btn-danger" style="padding:4px 8px;font-size:12px">🗑️ حذف</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>`;
        
        elements.historyTableContainer.innerHTML = table;
      }

      getStatusClass(type) {
        const statusMap = {
          'تنبيه شفهي': 'info',
          'تحذير مكتوب': 'warning',
          'إنذار رسمي': 'warning',
          'إنذار نهائي': 'danger',
          'تنبيه سلوك': 'info',
          'تنبيه أداء': 'warning',
          'تنبيه حضور': 'info'
        };
        return statusMap[type] || 'info';
      }

      viewWarning(id) {
        const warning = this.warnings.find(w => w.id == id);
        if (!warning) return;

        // Fill form with warning data
        Object.entries(warning).forEach(([key, value]) => {
          const element = elements[key];
          if (element && value) element.value = value;
        });

        // Switch to generator tab
        this.switchTab('generator');
        this.updatePreview();
        this.showNotification(`تم تحميل الإنذار #${warning.warningNo}`, 'info');
      }

      deleteWarning(id) {
        const warning = this.warnings.find(w => w.id == id);
        if (!warning) return;

        if (!confirm(`هل تريد حذف الإنذار #${warning.warningNo} للموظف ${warning.employee}؟`)) return;

        this.warnings = this.warnings.filter(w => w.id != id);
        this.saveWarnings();
        this.renderHistory();
        this.showNotification('تم حذف الإنذار بنجاح', 'success');
      }

      clearHistory() {
        if (!confirm('هل تريد حذف جميع الإنذارات المحفوظة؟')) return;

        this.warnings = [];
        this.saveWarnings();
        this.renderHistory();
        this.showNotification('تم مسح السجل بنجاح', 'info');
      }

      // Statistics
      updateStatistics() {
        const total = this.warnings.length;
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const thisMonth = this.warnings.filter(w => {
          const warningDate = new Date(w.date);
          return warningDate.getMonth() === currentMonth && warningDate.getFullYear() === currentYear;
        }).length;
        
        const finalWarnings = this.warnings.filter(w => w.type === 'إنذار نهائي').length;
        const uniqueEmployees = new Set(this.warnings.map(w => w.email)).size;

        elements.totalWarnings.textContent = total;
        elements.thisMonth.textContent = thisMonth;
        elements.finalWarnings.textContent = finalWarnings;
        elements.uniqueEmployees.textContent = uniqueEmployees;
      }

      // Draft management
      saveDraft() {
        if (this.settings.autoSave === 'disabled') return;

        const draft = {
          company: elements.company.value,
          employee: elements.employee.value,
          employeeId: elements.employeeId.value,
          email: elements.email.value,
          phone: elements.phone.value,
          department: elements.department.value,
          type: elements.type.value,
          severity: elements.severity.value,
          date: elements.date.value,
          dueDate: elements.dueDate.value,
          issuer: elements.issuer.value,
          message: elements.message.value,
          consequences: elements.consequences.value,
          warningNo: elements.warningNo.value
        };
        
        localStorage.setItem(STORAGE.DRAFT, JSON.stringify(draft));
      }

      loadDraft() {
        try {
          const draft = JSON.parse(localStorage.getItem(STORAGE.DRAFT) || '{}');
          if (Object.keys(draft).length === 0) return;

          Object.entries(draft).forEach(([key, value]) => {
            const element = elements[key];
            if (element && value) element.value = value;
          });

          this.updatePreview();
        } catch {
          // Ignore errors in draft loading
        }
      }

      startAutosave() {
        setInterval(() => this.saveDraft(), 5000);
      }

      // Notification system
      showNotification(message, type = 'info') {
        elements.notification.textContent = message;
        elements.notification.className = `notification ${type} show`;
        
        setTimeout(() => {
          elements.notification.classList.remove('show');
        }, 3000);
      }
    }

    // Initialize the app
    const app = new WarningApp();

    // Apply settings on load
    app.loadAppSettings();
    app.applySettings();

    // Global functions for onclick events
    window.app = app;
  </script>
</body>
</html>